Разрешение обработки Makefile внутри org

#+begin_src elisp
  (require 'ob-makefile)
#+end_src

Нужно экспортировать файлы с помощью src_elisp{(org-babel-tangle)}

* Makefile

#+begin_src makefile :tangle Makefile
  PACKAGE_NAME = course-task
  ORG_FILE = $(PACKAGE_NAME).org
  TEST_NAME = test
  ARCHIVE_FILES = Makefile course-work-task.sty test.tex

  $(TEST_NAME).pdf: $(TEST_NAME).tex $(PACKAGE_NAME).sty $(BUILD_DIR)
	  pdflatex $(TEST_NAME).tex

  $(PACKAGE_NAME).sty $(TEST_NAME).tex environment.tex commands.tex: $(PACKAGE_NAME).org $(BUILD_DIR)
	  emacs --script org-tangle.el "$(ORG_FILE)"

  $(PACKAGE_NAME).zip: $(ARCHIVE_FILES)
	  zip $(PACKAGE_NAME).zip $(ARCHIVE_FILES)

  install-packages:
	  sudo apt-get install -y texlive-base texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra texlive-lang-cyrillic texlive-bibtex-extra
#+end_src

** DONE Makefile itself

#+begin_src makefile :tangle Makefile
  Makefile: $(ORG_FILE)
	  emacs --batch --exec "(progn (find-file \"$(ORG_FILE)\") (org-babel-tangle nil nil makefile))"
#+end_src



** Требуемые пакеты

* Новая версия
  :PROPERTIES:
  :header-args:latex: :tangle course-task.sty
  :END:

- [X] Разделить пакет на файлы:
  - Главный файл ~course-task.sty~
    - Команды ~commands.tex~
    - Вспомогательные команды ~internal.tex~
    - Окружение ~environment.tex~
      - [ ] ~env-before.tex~
      - [ ] ~env-after.tex~

- [ ] Префикс имен: ~CWT~

** Наименование пакета

#+BEGIN_SRC latex :tangle course-task.sty
  \ProvidesPackage{course-task}[2018/11/30 v.2.0.0]
  \RequirePackage{soul}
  \RequirePackage{enumerate}
  \RequirePackage{etoolbox}

  \input{commands}
  \input{internal}
  \input{environment}
#+END_SRC

** Параметры и команды

Внесение даты вручную (если число определено пустым)
#+BEGIN_SRC latex :tangle internal.tex
\newcommand{\@handdate}{<<\hspace{7mm}>> {\hspace{2cm}} {20\hspace{7mm}}~г.}
#+END_SRC

Окружение начинается с
#+BEGIN_SRC latex :tangle environment.tex
  \newenvironment{CWtask}{
#+END_SRC

Параметры имеют три уровня значений (по возрастанию приоритетов):
- значение по умолчанию
- общее значение
- значение в окружении


- [ ] Работа с датами
  - [ ] Формат дат: \@date<type>[part]
    - <type>:
      - iss :: дата выдачи задания
      - end :: срок сдачи работы
    - [part]:
      - day :: день месяца
      - month :: месяц
      - year :: 4-значный год
  - [ ] Операции с датами:
    - [ ] Создать дату
      - [ ] Глобальную
      - [ ] Локальную
    - [ ] Напечатать дату (локальную)

*** Общие параметры бланков

**** DONE Заголовок

- Общий параметр
  #+BEGIN_SRC latex :tangle commands.tex
    \newcommand{\@CWheader}{}%
  #+END_SRC

- Общая команда
  #+BEGIN_SRC latex :tangle commands.tex
    \newcommand{\CWheader}[1]{%
      \renewcommand{\@CWheader}{#1}%
    }
  #+END_SRC

- Пример
 #+BEGIN_SRC latex :tangle description.tex
   \CWheader{CWheader(header)}
 #+END_SRC

**** Продолжение
  - Название кафедры ~\CWchair{chair}~
  - Название дисциплины ~\CWcourse{course}~
  - Срок сдачи ~\CWenddate{date}~
    - общие даты: ~\@CWenddateday~, ~\@CWenddatemonth~,
      ~\@CWenddateyear~
      #+BEGIN_SRC latex :tangle commands.tex
        \newcommand{\@CWenddateday}{}
        \newcommand{\@CWenddatemonth}{}
        \newcommand{\@CWenddateyear}{}
      #+END_SRC
    - общая команда:
      #+BEGIN_SRC latex :tangle commands.tex
        \newcommand{\CWenddate}[3]{
          \renewcommand{\@CWenddateday}{#1}
          \renewcommand{\@CWenddatemonth}{#2}
          \renewcommand{\@CWenddateyear}{#3}
        }
      #+END_SRC
    - даты в окружении:
      #+BEGIN_SRC latex :tangle environment.tex
        \newcommand{\@enddateday}{\@CWenddateday}
        \newcommand{\@enddatemonth}{\@CWenddatemonth}
        \newcommand{\@enddateyear}{\@CWenddateyear}
      #+END_SRC

**** DONE Заголовок задания

- Общий параметр
  #+BEGIN_SRC latex :tangle commands.tex
    \newcommand{\@CWname}{ЗАДАНИЕ НА КУРСОВУЮ РАБОТУ}%
  #+END_SRC
- Общая команда
  #+BEGIN_SRC latex :tangle commands.tex
    \newcommand{\CWname}[1]{%
      \renewcommand{\@CWname}{#1}%
    }
  #+END_SRC

*** Частные параметры бланков
  - Дата выдачи ~\CWissdate{date}~, ~\issdate{date}~
    - общие даты: ~\@CWissdateday~, ~\@CWissdatemonth~,
      ~\@CWissdateyear~
      #+BEGIN_SRC latex :tangle commands.tex
        \newcommand{\@CWissdateday}{}
        \newcommand{\@CWissdatemonth}{}
        \newcommand{\@CWissdateyear}{}
      #+END_SRC
    - общая команда:
      #+BEGIN_SRC latex :tangle commands.tex
        \newcommand{\CWissdate}[3]{
          \renewcommand{\@CWissdateday}{#1}
          \renewcommand{\@CWissdatemonth}{#2}
          \renewcommand{\@CWissdateyear}{#3}
        }
      #+END_SRC
    - даты в окружении: ~\@issdateday~, ~\@issdatemonth~,
      ~\@issdateyear~
      #+BEGIN_SRC latex :tangle environment.tex
        \newcommand{\@issdateday}{\@CWissdateday}
        \newcommand{\@issdatemonth}{\@CWissdatemonth}
        \newcommand{\@issdateyear}{\@CWissdateyear}
      #+END_SRC
    - команда в окружении
      #+BEGIN_SRC latex :tangle environment.tex
        \newcommand{\issdate}[3]{
          \renewcommand{\@issdateday}{##1}
          \renewcommand{\@issdatemonth}{##2}
          \renewcommand{\@issdateyear}{##3}
        }
      #+END_SRC
  - [ ] Фамилия, имя, отчество руководителя (общие и в окружении) ~\CWadviser{surname}{initials}~, ~\adviser{surname}{initials}~

**** DONE Данные для выполнения работы

- Общий параметр:
  #+BEGIN_SRC latex :tangle commands.tex
    \newcommand{\@CWmaterials}{данные для выполнения работы}
  #+END_SRC
- Общая команда:
  #+BEGIN_SRC latex :tangle commands.tex
    \newcommand{\CWmaterials}[1]{%
      \renewcommand{\@CWmaterials}{#1}%
    }
  #+END_SRC
- Параметр в окружении (наследует):
  #+BEGIN_SRC latex :tangle environment.tex
    \newcommand{\@materials}{\@CWmaterials}
  #+END_SRC
- Команда в окружении:
  #+BEGIN_SRC latex :tangle environment.tex
    \newcommand{\materials}[1]{
      \renewcommand\@materials{##1}
    }
  #+END_SRC

*** Индивидуальные параметры
  - Фамилия, имя, отчество студента
    - параметры в окружении: ~\@authorsign~, ~\@authorfull~
      #+BEGIN_SRC latex :tangle environment.tex
        \newcommand{\@authorsign}{}
        \newcommand{\@authorfull}{}
      #+END_SRC
    - команда в окружении: ~\author{sign}{full-gen}~
      #+BEGIN_SRC latex :tangle environment.tex
        \renewcommand{\author}[2]{
          \renewcommand{\@authorsign}{##1}
          \renewcommand{\@authorfull}{##2}
        }
      #+END_SRC
  - Тема работы
    - команда в окружении: ~\title{title}~
      TODO: разобраться почему @title уже определена
      #+BEGIN_SRC latex :tangle environment.tex
        \let\@oldtitle\@title
        \renewcommand{\@title}{}
      #+END_SRC
    - параметр в окружении: ~\@title~
      #+BEGIN_SRC latex :tangle environment.tex
        \renewcommand{\title}[1]{
          \renewcommand{\@title}{##1}
        }
      #+END_SRC
  - Содержание работы (обязательные вопросы)
    - параметр в окружении: ~\@content~
      #+BEGIN_SRC latex :tangle environment.tex
        \newcommand{\@content}{}
      #+END_SRC
    - команда в окружении: ~\content{questions}~
      #+BEGIN_SRC latex :tangle environment.tex
        \newcommand{\content}[1]{
          \renewcommand{\@content}{##1}
        }
      #+END_SRC


** TODO Формирование бланка

*** Окружение пунктов задания

Пункты задания состоят из двух частей, причем вторая часть выводится
курсивом
#+BEGIN_SRC latex :tangle internal.tex
  \newenvironment{@points}{%
    \newcommand{\@point}[2]{%
      \item
        \noindent ##1 {\textsl{##2}} 
    }%
    \begin{enumerate}[1.]{%
    \setlength{\parsep}{0pt}%
    \setlength{\topsep}{0pt}%
    \setlength{\itemsep}{3mm plus 3mm minus 1mm}%
    \setlength{\labelsep}{0pt}%
    \setlength{\labelwidth}{0pt}%
    \setlength{\leftmargin}{0pt}%
    \setlength{\itemindent}{0pt}}}{%
    \end{enumerate}
  }
#+END_SRC

*** Закрытие скобок

#+BEGIN_SRC latex :tangle environment.tex
  }{
#+END_SRC

*** Заглавие документа

#+BEGIN_SRC latex :tangle environment.tex
    \begin{center}
      \small \@CWheader
    \end{center}

    % \begin{CourseWorkTaskListExplanation}[30mm]
    % \item{Кафедра:} \@CourseWorkTaskChairName
    % \item{Дисциплина:} \@CourseWorkTaskCourseName
    % \end{CourseWorkTaskListExplanation}
#+END_SRC

*** TODO Заголовок документа

- [ ] Отделить заголовок с возможностью задать новый

#+BEGIN_SRC latex :tangle environment.tex
    \begin{center}
      \@CWname \\
      \sl{\@authorfull}
    \end{center}
#+END_SRC

*** Основная часть

**** Начало пунктов

#+BEGIN_SRC latex :tangle environment.tex
    \begin{@points}
#+END_SRC

**** DONE Тема работы

#+BEGIN_SRC latex :tangle environment.tex
      \@point{Тема работы:}{<<\@title>>}
#+END_SRC

**** DONE Срок сдачи работы

#+BEGIN_SRC latex :tangle environment.tex
       \@point{Срок сдачи завершенной работы}{{<<\@enddateday>>} {\@enddatemonth} {\@enddateyear~г.}}
#+END_SRC

**** DONE Материалы для работы

#+BEGIN_SRC latex :tangle environment.tex
      \@point{Материалы для выполнения работы:}{\@materials}
#+END_SRC

**** DONE Содержание расчетно-пояснительной записки

#+BEGIN_SRC latex :tangle environment.tex
      \@point{Содержание расчетно-пояснительной записки:}{\@content}
#+END_SRC

**** DONE Дата выдачи задания

#+BEGIN_SRC latex :tangle environment.tex
       \@point{Задание выдано}{{<<\@issdateday>>} {\@issdatemonth} {\@issdateyear~г.}}
#+END_SRC

**** Конец пунктов

#+BEGIN_SRC latex :tangle environment.tex
    \end{@points}
#+END_SRC

*** DONE Поле подписей

#+begin_src latex :tangle environment.tex
  {\noindent
    \begin{center}
      \begin{tabular}{l c l}
	Руководитель & \underline{\hspace{3cm}} & И. О. Фамилия \\
	Студент & \underline{\hspace{3cm}} & \@authorsign \\
	%% Руководитель &  &  \@CourseWorkTaskAdviserNomShortpre \\
	%% Задание принял к исполнению & \underline{\hspace{3cm}} & \@CourseWorkTaskAuthorNomShortpre \\
      \end{tabular}
    \end{center}}
  % \vfil
  \newpage
#+end_src

*** Конец отображения окружения

#+begin_src latex :tangle environment.tex
  }
#+end_src

** Описания команд

#+begin_src latex :tangle description.tex
  \begin{CWtask}
    \author{П. Автор}{Первый автор}
    \title{Все параметры по умолчанию}
    \content{Содержание работы №1}
  \end{CWtask}
#+end_src

** Тестовый фрагмент

#+BEGIN_SRC latex :tangle test.tex
  \documentclass[russian,utf8,columnviii,nocolumnsxix]{eskdtext}
  \DeclareRobustCommand{\No}{\ifmmode{\nfss@text{\textnumero}}\else\textnumero\fi}

  \usepackage[T2A]{fontenc}
  \usepackage{etoolbox}
  \usepackage{geometry}

  \usepackage{course-task}

  \begin{document}

  \ESKDstyle{empty}
  \newgeometry{left=3cm, right=1.5cm, top=1cm, bottom=1cm}

  \input{description.tex}

  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %% Common

  \CWheader{ФЕДЕРАЛЬНОЕ АГЕНТСТВО НАУЧНЫХ ОРГАНИЗАЦИЙ \\
  ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ БЮДЖЕТНОЕ НАУЧНОЕ УЧРЕЖДЕНИЕ \\
  <<ФЕДЕРАЛЬНЫЙ НАУЧНЫЙ АГРОИНЖЕНЕРНЫЙ ЦЕНТР ВИМ>> \\
  (ФГБНУ ФНАЦ ВИМ)}
  \CWmaterials{общие материалы для работы: учебники, учебные пособия,
    научные книги и статьи по теме курсовой работы, материалы сети
    Интернет}
  \CWissdate{15}{февраля}{2018}
  \CWenddate{20}{мая}{2019}

  \begin{CWtask}
    \author{П. Автор}{Первый автор}
    \title{Тема работы №1}
    \materials{Материалы для работы №1}
    \content{Содержание работы №1}
  \end{CWtask}

  \begin{CWtask}
    \author{В. Автор}{Второй автор}
    \title{Тема работы №2}
    \content{1. Оценка рынка.  2. Оборудование, материалы и персонал для
      производства.  3. Технико-экономическая оценка продукции}
    \issdate{2}{февраля}{2001}
  \end{CWtask}

  \end{document}
#+END_SRC
